#{extends 'main.html' /}

<script src="@{'/public/javascripts/jquery.fullscreen.js'}"></script>
      <!-- <script src="@{'/public/javascripts/d3.v2.min.js'}"></script>-->
      

<script src="@{'/public/javascripts/highcharts.js'}"></script>
<script src="@{'/public/javascripts/exporting.js'}"></script>
<script src="@{'/public/javascripts/mapping/map_functions.js'}"></script>

<script src="@{'/public/javascripts/mapping/attach_events.js'}"></script>
<script src="@{'/public/javascripts/mapping/TileLayer.TileJSON.js'}"></script>
<!-- <script src="@{'/public/bootstrap/js/bootstrap-notify.js'}"></script> -->
<link rel="stylesheet" media="screen" href="@{'/public/bootstrap/css/bootstrap-notify.css'}"/>





#{set title:'Home' /}

<style type="text/css">
   
.dial {
  float:left;
  width:140px;
  margin-left:10px;
  position:relative;
  left:10%;
}

.dial.first {
  margin-left:0;
}

.dial h2 {
  font-weight:bold;
}

.dial ul {
  background:#fff;
  border:1px solid #bbb;
  padding:25px 0 114px 0;
  height:1px;
  overflow-y:scroll;
}

.dial ul:before {
  content://;
  border:10px solid #555;
  width:1px;
  height:1px;
  display:block;
  position:absolute;
  bottom:105px;
  left:0;
  z-index:3;
  border-top-color:transparent;
  border-right-color:transparent;
  border-bottom-color:transparent;
}

.dial li {
  height:20px;
  line-height:20px;
  padding:10px 10px 10px 20px;
  border-bottom:1px solid #ddd;
  font-size:20px;
}

.dial li:first-child {
  border-top:1px solid #ddd;
}

#plot_graphic,#plot_list
{
cursor:pointer;

}
.red_tipsy
{
  font-weight: bold;
  color: #d12a2a;
}

.yellow_tipsy
{
  font-weight: bold;
  color: #ffea00;
}
.wax-tooltip span:hover
{
  cursor: pointer;
  background-color: #BBF486;
  color: black;
  margin: 4px;
  
}

#datapublisher_table td,#datasets_table td
{
font-size:14px;
text-align: center;
color: black;
font-weight: bold;
}
#datapublisher_table th,#datasets_table th
{

font-size:13px;
text-align: center;
color: #c42f2f;
}
#datapublisher_table,#datasets_table 
{

background:#DDDDDD;
 -webkit-transition:opacity .5s;
  -moz-transition:opacity .5s;
  box-shadow:0px 0px 10px #5CACEE;
  -moz-box-shadow:0px 0px 10px #5CACEE;
  -webkit-box-shadow:0px 0px 10px #5CACEE; border:2px solid #5CACEE;
}

  .notify
  {
  font-size:16px;
  font-color:#d12268;
  background: #7788e0;
  border: solid 1px #1a1616;
  }
.wax-tooltip {
  z-index:50;
  position:absolute;
  background:#1a1a1a;
  color:#fff;
  padding:7px;
 // left:1100px;
 right: 10px;
  top:30px;
  border:2px solid #5CACEE;
  border-radius:2px;
  max-width:300px;
  max-height: 400px;
  overflow: auto;
  opacity:1;
  font-type: Georgia;
  line-height: 1.3em;
  font-size: 1em;
//  width: auto;
  -webkit-transition:opacity .9s;
  -moz-transition:opacity .9s;
  box-shadow:0px 0px 10px #5CACEE;
  -moz-box-shadow:0px 0px 10px #5CACEE;
  -webkit-box-shadow:0px 0px 10px #5CACEE;
  }

.taxa_table td {
  padding: 8px;
  line-height: 14px;
  text-align: center;
  vertical-align: center;
  
}

.td_selected
{
cursor:pointer;
background:#f54f4f;
color:white;
font-weight: bold;
font-size: 18px;
}
.td_hovered
{
cursor:pointer;
background:#3e71f0;
color:white;
font-weight: bold;
font-size: 18px;
}


.selected
{
  color: #C60F0F;
  font-weight: bold;
  cursor:pointer;
}
        #map path  {
            
             stroke-width: 0.5px;
            stroke: #3b3535;
            shape-rendering: crispEdges;
        }



#map_tooltip
  {
width:auto;position:relative;z-index:50;background:#DDDDDD; color:#6053;font-size: 1.1em;  
max-height:50px;
 -webkit-transition:opacity .5s;
  -moz-transition:opacity .5s;
  box-shadow:0px 0px 10px #5CACEE;
  -moz-box-shadow:0px 0px 10px #5CACEE;
  -webkit-box-shadow:0px 0px 10px #5CACEE; border:2px solid #5CACEE;
  border-radius:2px;

}
</style>

<script type="text/javascript">


var datapublisher_id=parseInt("${dataPublisher.id}");



var polygon;

   

simple_orderby= function(type,big_array,to_plot)
            {
var sorted_array=big_array.sort(compareCount);           
return sorted_array;
}

orderby= function(type,big_array,to_plot)
            {



var content='';
   
 //           content+="<h3>"+to_plot+" abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
            switch (to_plot)
            {
            case 'genus': 
            var content="<h3>Genus abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
            break;
            
      case 'scientificname': 
      var content="<h3>Species abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break;       

          case 'family': 
      var content="<h3>Family abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break;    
             case 'classs': 
      var content="<h3>Class abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break; 
                case 'order': 
      var content="<h3>Order abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break;       
                   case 'order': 
      var content="<h3>Phylum abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break;

            }
            if (type=='counts')
            {
         //   console.warn(to_plot)
            content+="<span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
          
            var sorted_array=big_array.sort(compareCount);            
            }
            if (type=='names')
            {

            content+="<span style='color:#0CACF7' id='orderby_counts'>Order by abundance</span></br>";
            var sorted_array=big_array.sort(compareName);                 
            }

      for (i=0;i<sorted_array.length;i++)
      {
//      $taxa_div=$('<div>'+sorted_array[i][0]+'</div>');
      content+='<span><div class="red_tipsy">'+sorted_array[i][0]+'</div> '+sorted_array[i][1]+'</span></br>';
        
      }
     
//      console.info(content)
      $('#wax-tooltip_content').empty().append(content).show();
    
      if (!$('.wax-tooltip').is(':visible'))  $('.wax-tooltip').show()

        $('#wax-tooltip_content div').tipsy({ 
            container: $('#map'),
                              delayIn: 200, 
                              fade: true, 
                              gravity: 'e', 
                opacity:1,
                              offset: 15,
                              delayOut: 3000,
                              html: true, 
                              title: function(e,target) {                               
                                var this_taxa=$(this).html();   
                                        
              if (datapublisher_id==4)
              {
    var text='<div id="explore_sp"><a this_taxa="'+this_taxa+'" deg="2" href="#" class="by_polygon">Visualize 2 degrees area</a><p>';
                text+='<a this_taxa="'+this_taxa+'" deg="4" href="#" class="by_polygon">Visualize 4 degree area</a><p>';
              }
           else
           {


                var text='<div id="explore_sp"><a this_taxa="'+this_taxa+'" deg="1" href="#" class="by_polygon">Visualize 1 degrees area</a><p>';
                text+='<a this_taxa="'+this_taxa+'" deg="0_5" href="#" class="by_polygon">Visualize 0.5 degree area</a><p>';
               }
                                
                                
                                
                               // text+='<a this_taxa="'+this_taxa+'" href="#" class="heatmap">Visualize heatmap</a><br>
                               text+='<a this_taxa="'+this_taxa+'" href="#" class="canvas">Visualize individual occurrences</a>';
                              text+='</div>';
                                // text+='<p><a this_taxa="'+this_taxa+'" href="#" class="by_all">Get clusters for all collections</a>';
                             
                                return text;
                                
                              }
                            });

}
  
 $('#explore_sp a').live('click',function()
{

cluster_action=$(this).attr('class')
window.taxa=$(this).attr('this_taxa').toString();
if (cluster_action=='by_polygon')
{
window.pol_degree=$(this).attr('deg')
show_by_polygon2('datapublisher')
}

if (cluster_action=='canvas')
 {
jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_extents_canvas_final.php',
  data:  {'taxa':taxa,'type':to_plot,'data_type':'datapublisher','datapublisher_id':datapublisher_id},
 
 dataType: 'jsonp',
 success: function(data)
 {

$.each(map._layers, function(index, value)  
      {
      if (value.type=='canvas')
      {
map.removeLayer(value)
      }
      })


if (data.main_bbox[0].length= 0) 
  {
   alert('some error in bbox??')
   zoom=2;
    map.fitWorld()
  }
  else
  {
  if (typeof data.main_bbox[1]=='undefined') alert('We cannot get any geo-referenced record for this taxa')
    else
    {

       
        
     var max=data.max;
                     
    var up_right=data.main_bbox[1].split(',')
    var bottom_left=data.main_bbox[0].split(',')
    
 bounds = new L.LatLngBounds(
        new L.LatLng(bottom_left[1],bottom_left[0]),

        new L.LatLng(up_right[1],up_right[0]));

zoom=map.getBoundsZoom(bounds)

var message='<b>'+addSeparator(data.total)+'</b> occurrences of taxa <b>'+taxa+'</b> distributed in <b>'+addSeparator(data.num_clusters)+'</b> circles<br><b>Minimum</b> '+addSeparator(data.min)+'   <b>Maximum</b> '+addSeparator(data.max);

if ($('.notify').size()>0) $('.notify').remove()

$('#map_tooltip').before("<div class='notify'>"+message+"</div>").show()

map.fitBounds(bounds) 

var tile = new L.TileLayer.TileJSON({
        debug: false,
        opacity:0.6,
       
        // this value should be equal to 'radius' of your points        
        buffer: 5
    });
  tile.type='canvas';      
        

     tile.createUrl = function (bounds) {
 

   var bbox='BOX('+bounds[0]+'  '+bounds[1]+','+bounds[2]+' '+bounds[3]+')'
        var url = 'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/canvas_test_final.php?data_type=datapublisher&type='+to_plot+'&taxa='+taxa+'&zoom=5&datapublisher_id='+datapublisher_id+'&BBOX='+bbox;          
       return url
    };
    tile.styleFor = function (feature) {

  /*  var count_extent = d3.extent(features, function(d){return d.properties.count});
    var opacityScale = d3.scale.linear()
                     .domain([0, d3.max(features, function(d) { return d.properties.count; })])
                     .range([0.2, 1]);  
    */                 
                     
        var type = feature.geometry.type;
        var count=feature.properties.count
        

 
 var zoom=map.getZoom();

 if (count>0)
 {
 if (zoom<=5)
 {
  var radius=Math.log(count)*zoom/2;
 }
 else
 {
  var radius=Math.log(count)*zoom;
 }
 }
  console.info(radius)
 
        switch (type) {
            case 'Point': return {
                    color: '#ff0088',
                    radius: radius,
                     stroke_color:'blue'
                };

            default:
                return null;
        }
    };
       map.addLayer(tile);

tile.bringToFront();


      //  $menu_manager=$('#menu_manager')
       
      // $('#occ_manager').append("<div id='canvas_manager'><li><label id='canvas'><span style='width:50px;height:50px;color:black' >▉</span>  <b> "+taxa+'  </b><span action="remove_canvas">   Remove   </span></li></div>')

$('#canvas').click(function()
{

$.each(map._layers, function(index, value)  
      {
      if (value.type=='canvas')
      {
map.removeLayer(value)
      }
      })
      $('#canvas_manager').remove()
      
})
   // if (!$menu_manager.is(':visible')) $menu_manager.show();
    
    }



  }


 }
})
}
})
 
var new_colors=$.xcolor.analogous('#a5db97',30);
colors=new Array();
for (d in new_colors)
{
var this_color_obj=new_colors[d]
var this_color='rgb('+this_color_obj.r+','+this_color_obj.g+','+this_color_obj.b+')'
colors.push(this_color)
}

function render_highchart (render_to,this_array,title)
{
  if (!$("#data_list-dropdown-trigger").is(':visible')) $("#data_list-dropdown-trigger").show()
  chart = new Highcharts.Chart({
            chart: {
               backgroundColor: 'white',
                renderTo: render_to,
                //'graph_freq_taxa',
               
                plotBorderWidth: null,
                plotShadow: false
               
            },
            colors:colors,
            // title: {
            //     text: title
            // },
            tooltip: {
              useHTML: true,

            formatter: function(){
                return '<span class="my_highcart_tooltip">'+this.point.name+' '+addSeparator(this.point.y)+' ('+this.point.percentage.toFixed(2)+'%)</span>';
            },
          //    pointFormat: '<b>{point.y}</b> ({point.percentage})%</b>',
              backgroundColor: 'rgba(20,19,19,1)',

              
              percentageDecimals: 1,
              style: {
                    
                    borderWidth: 2,
                    borderColor: '#AAA',
                    color:'white',
                    overflow:'auto',
                    width:'200px',
                    fontSize: '10pt',
                padding: 10,
                fontWeight: 'bold'
            }
            },
            plotOptions: {
                pie: {
                    //showInLegend:true,
                    allowPointSelect: true,
                    borderColor: '#DAE4E8',
                     borderWidth: 1,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,

                        style: {
                          
                          color:'black',
                          fontSize: '12px'
                        },
                        useHTML:true,
                        formatter: function () 
                        {
                          var label_type;
                          var this_name=this.point.name;
                          if (render_to=='graph_freq_taxa')                        
                        {
                           label_type='taxa_label';
                            if (this_name.length>20)
                          {
                            this_name=this_name.split(' ');
                            this_name=this_name[0]+' '+this_name[1]
                          }
                        }
                             if (render_to=='graph_freq_dataset')                        
                        {
                             label_type='datasets_label';
                        }
                          
                          

                    return '<div style="max-width:100px;height:auto;" class="'+label_type+'" id="'+this.point.config[2]+'"><b>'+this_name+'</b></div>';
                  //  return '<div id="'+this.point.config[2]+'"><b>'+this.point.name+'</b></div>'
                          // : '+this.y+' occurrences
                         } 
                     }
                    ,
                    // showInLegend: true
                }
            },
              legend: {
            align: 'right',
            verticalAlign: 'top',
            width:100,
            
             
            x: -100,
            y: 100
          },
            series: [{
                type: 'pie',
                
                data: this_array,
                 events: {
                                  click: function(e) {
                                  //    alert ('A series was added');
                                  console.warn(e.point)
                                 console.info(e.point.config[0])
              
                                  }
                              }
            }]
        });

 function search_ecatID (this_taxa)
 {
        return function ()
  {
  console.log('my taxa is'+this_taxa)
  $.getJSON('http://ecat-dev.gbif.org/ws/usage/?rkey=1&q='+this_taxa+'&searchType=canonical&callback=?',
       { format:'JSONP'},
       function(json, textStatus) 
    {
      var id=json.data[0].taxonID;
      console.warn(id)
      return id;
      
      
      //optional stuff to do after success
    });
  }
 }
 
 } 




jQuery(document).ready(function($) {

var datapublisher_id=parseInt("${dataPublisher.id}");
var map_left=$('#map_container').offset().left;
var map_w=$('#map').width();
var map_h=$('#map').height();
var need_resizing;



jQuery('#fullscreen').click(function ()
{

var h=$(window).height();
var w=$(window).width();
recalculate_position(map_left,w,h);

map.invalidateSize(true);
need_resizing=true;

})


$('#no_fullscreen').click(function (e) {

  $('#map_container').css({left:map_left})
  $('#map').css({height:map_h,width:map_w,left:0});
  var h=$(window).height();
   var w=$(window).width();

$('#map_ajax_image').css({left:map_w/2,top:map_h/2})
  map.invalidateSize(true);
  e.preventDefault();
  need_resizing=false;


});


$('#remove_pol').live('click',function ()
{
$('path').remove()
$('#remove_pol').hide()
})

var datapublishers_json = (function () {
    var json = null;
    $.ajax({
        'async': false,
        'global': false,
        'url': 'http://www.gbif.fr:8080/portal-test/public/json/datapub_stats/taxa_graphic_simple/datapublisher_'+datapublisher_id+'_graphic.json',

        'dataType': "json",
        'success': function (data) {
            json = data;
            
            for (dataset_id in data)
            {
          
              if (dataset_id!=='datapublisher_info')
              {
              var html='<tr id="dataset_'+dataset_id+'">';
              var dataset_info=data[dataset_id]['dataset_info'][0]

                  
                for (info in dataset_info)
                {

                html+='<td>'+addSeparator(dataset_info[info])+'</td>';
                }
                html+='</tr>';
                
                $('#datasets_table tr:first').after(html)
         
              }
              else
              {
              var html='<tr>';
                var datapublisher_info=data['datapublisher_info'][0]                
                for (info in datapublisher_info)
                {                
                if (typeof(datapublisher_info[info])!=='string' && info!=='datapublisher_id')
                {
                html+='<td>'+addSeparator(datapublisher_info[info])+'</td>';
                }
                
                }
                html+='</tr>';
                
                $('#datapublisher_table tr:first').after(html)
              }
            }

               
        }
    });
    return json;
})(); 
var taxa_array=null;
function get_data (taxa_level,dataset_id,top,to_plot,data_type,datapublisher_id)
{

$.ajax({
       // url: 'http://localhost:8888/parsing_json.php',
       url: 'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/parsing_json.php',
        data:{'taxa_level':taxa_level,'dataset':dataset_id,'datapublisher':datapublisher_id},
        dataType: 'jsonp',
        success: function (data) {
          console.warn(data)
            taxa_array=data[taxa_level];
            var top_taxa=[];
            var top=10;
            
            for (var i = 0; i < taxa_array.length; ++i)
          {    
      
      if (i<top)
      {
           
              top_taxa.push(taxa_array[i])
            }
          }

        
          

          var order_by_count=simple_orderby('count',taxa_array,'testing') 
          var html='<ul style="width:auto;list-style:none;">'
          
          $(order_by_count).each(function(i,d)
          {           
          html+='<li>'+d[0]+' <span class="red_tipsy">'+addSeparator(d[1])+'</span></li>';
          })
          html+='</ul>';
          if (data_type=='graphic')
          {
         $('#graphic').animate({'height':350},100); 
          render_highchart('graphic',top_taxa,' occurrences d\'un  total de 234') 
           $('#data_list-dropdown').append(html)
          }
           else
           {
          to_plot.find('#my_data').append(html)  
           }
          
          //

          }

        })
return taxa_array;
}

// $('body').click(function ()
//   {
//     var top=10;
//     get_graphic ('genus',83,top)

// })
//render_highchart('graphic',taxa_array,taxa_count+' occurrences d\'un  total de '+total)

//  $('#mouseover_span').tipsy({fade: true, opacity:1,gravity: 'e', html: true, live: true,
// title: 'title'
                       
//   });

var lat=48.856930;
var lng=2.341200;
var latlng=new L.LatLng(lat,lng);


 map = new L.Map('map',{ 'crs': L.CRS.EPSG900913});
 map.config_event='mouseup';
map.addLayer(new L.Marker(latlng)); 

  $map=$('#map').get(0)

 var ajax_x=map_w/2
var ajax_y=map_h/2

$('#map').append('<img id="map_ajax_image" style="display:none;position:relative;width:50px;height:50px;left:'+ajax_x+'px;top:'+ajax_y+'px" src="../../../public/images/spinner3-greenie.gif"/>')

var url = window.location.search.split("id=");
var datapublisher_id=url[1];


var datapublisher_info=datapublishers_json.datapublisher_info[0];

var datapublisher_name=datapublishers_json.datapublisher_name;
// alert(typeof(datapublisher_name))

// if (typeof(datapublisher_name)=='undefined')
// {
// alert('carto not ready');
// $('#map,.navbar,#fullscreen,#no_fullscreen').hide()
// }
// else
// {
$('#map_tooltip').html('<h2><b>'+addSeparator(datapublisher_info.datapublisher_geo_count)+'</b> occurrences géoreferencés').fadeIn('slow')
 var simple_datapublisher_url='http://www.gbif.fr/mbtiles/datapublishers/datapublisher_'+datapublisher_id+'_dp/metadata.jsonp'; //_dp

 
$map=$('#map').get(0)
// $('#map').append("<div id='mouseover_span' style='position:relative;cursor:pointer;width:20px;height:20px;opacity:0.01;background-color:blue'></div>")


       // url='http://a.tiles.mapbox.com/v3/pereion.map-3b3ppzbe.jsonp';
         var url='http://a.tiles.mapbox.com/v3/examples.map-dev-fr.jsonp'
     wax.tilejson(url, function(tilejson) {
        console.warn('added basemap')
          basemap = new wax.leaf.connector(tilejson);
         map.addLayer(basemap,true);
         })
var content;
// $('.hoverbox').live('click',function (e)
//   {
//     var $target=$(e.target)
//     if (e.target.id=='more_info')
//     {
      
      
//       var point_id=$(this).find('#point_centroid').attr('class')

//        jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_counts_point.php',
//              data: {point_id:point_id,data_id:datapublisher_id,'data_type':'datapublisher'},
//              type: 'GET',
//             dataType: 'jsonp',
//             success: function(data)
//             {
//             var content='<div id="show_scientificname_id">Nombre espèces <b>'+data.num_species+'</b>';
//             content+='<div id="show_genus_id"><b>'+data.count_genus+'</b> different Genus</div></br>';
//                 // content+='<div id="show_family_id"><b>'+obj.count_family+'</b> different Families</div></br>';
//             content+='<div id="show_scientificname_id"><b>'+data.count_scientificname+'</b> different Species</div></br>';
//             content+='<div id="show_phylum_id"><b>'+data.count_phylum+'</b> different Phylums</div></br>';
//             content+='<div id="show_class_id"><b>'+data.count_classs+'</b> different Class</div></br>';
//             content+='<div id="show_order_id"><b>'+data.count_orderr+'</b> different Order</div></div>';
            
//             $target.html(content)               
              
//                 }
//               })
//     }
   
//   })
 
   map.scrollWheelZoom.disable();

    wax.tilejson(simple_datapublisher_url, function(tilejson) {
          this_datapublisher = new wax.leaf.connector(tilejson);
           map.addLayer(this_datapublisher,false);
             this_datapublisher.bringToFront()
         this_datapublisher.setOpacity(1)

    this_datapublisher.type='data_points';
    this_datapublisher.my_id='datapublisher_'+datapublisher_id+'_dp';

    this_datapublisher.my_url=simple_datapublisher_url;
       this_datapublisher.points_type='datapublisher';

         var center=tilejson.center.split(',')
         var lat=center[1];
        var lng=center[0];
        var zoom=center[2];
        var latlng=new L.LatLng(lat,lng);

         map.setView(latlng, zoom);
 map._initPathRoot() 

 svg = d3.select("#map").select("svg")
 g = svg.append("g");


 var latlng=new L.LatLng(0,0)
  
mouseover_circle = g.selectAll("mouseover_circle").data(function ()
    {
       return [latlng];
    })


mouseover_circle.enter().append("circle").attr('class','mouseover_circle')
mouseover_circle.attr("cx",function(d) {  return map.latLngToLayerPoint(d).x})
mouseover_circle.attr("cy",function(d) { return map.latLngToLayerPoint(d).y}).attr("stroke", "#f22703")
mouseover_circle.attr("r", 10).attr('fill','#ffdd00').attr('opacity',0);

 $('circle.mouseover_circle').tipsy({ opacity:1,gravity: 'n', html: true, offset:1,delayOut:10000,container: $('#map'),
 title: 'title'
                       
   });


var requested_latlng;




  map.on("viewreset dragend zoomend", function ()
  {
      reset();
   $(".tipsy").hide()
      this_datapublisher.bringToFront();

      if(parseInt($("circle.mouseover_circle").attr('opacity'))!==0)
 {
  var request_x=map.latLngToLayerPoint(requested_latlng).x;
  
  var request_y=map.latLngToLayerPoint(requested_latlng).y;


  mouseover_circle.transition()
  .attr("cx",request_x).attr("cy",request_y).duration(10).attr('opacity',1); 
}


    $("circle.mouseover_circle").attr('original-title','');
  })


    this_datapublisher.interaction= wax.leaf.interaction(this_datapublisher)
    this_datapublisher.interaction.map(map)
    .tilejson(tilejson)     
    .on({
      on: function(o) {
 // console.warn(map.mouseEventToLatLng(o.e))

         if (o.e.type == 'mousemove') 
        {
     
var relativeX = o.e.pageX - $map.offsetLeft-10; 
var relativeY = o.e.pageY - $map.offsetTop-10;
var obj=o.data;


var dataset_info,dataset_name; 

var latlng=map.mouseEventToLatLng(o.e);

requested_latlng=map.mouseEventToLatLng(o.e);

 var this_y=map.latLngToLayerPoint(latlng).y
var this_x=map.latLngToLayerPoint(latlng).x

mouseover_circle.transition()
  .attr("cx",this_x).attr("cy",this_y).duration(150).attr('opacity',1)   


       //datapublisher_name=data.dataset_id;
   // for (dataset_id in datapublishers_json)
   //          { 
   //            console.log(dataset_id)
   //            console.warn(obj.dataset_id)
   //            console.info(dataset_id==obj.dataset_id)
   //    if (dataset_id==obj.dataset_id)
   //    {
   //      dataset_info=datapublishers_json[dataset_id];//.dataset_info[0]
   //      console.warn(dataset_info)
   //      dataset_name='test';
   //      //dataset_info.dataset_name

   //          }
   //        }
     
     // <div id="tooltip_datapublisher_id" class="'+datapublisher_id+'" > Datapublisher <b>'+datapublisher_name+'</b></div></br><div id="tooltip_dataset_id" class='+obj.dataset_id+'>Dataset <b>'+dataset_name+'</b></div></br>

    


      
//                content='<div onClick="show_species('+>Number of species '+obj.count_scientificname+'</br>';
        // content+='<div id="show_genus_id"><b>'+obj.count_genus+'</b> different Genus</div></br>';
        //         // content+='<div id="show_family_id"><b>'+obj.count_family+'</b> different Families</div></br>';
        //         content+='<div id="show_scientificname_id"><b>'+obj.count_scientificname+'</b> different Species</div></br>';
        //         content+='<div id="show_phylum_id"><b>'+obj.count_phylum+'</b> different Phylums</div></br>';
        //           content+='<div id="show_class_id"><b>'+obj.count_classs+'</b> different Class</div></br>';
        //             content+='<div id="show_order_id"><b>'+obj.count_orderr+'</b> different Order</div></div>';

      
                 
      
    
//$('#mouseover_span').css({'top':relativeY+'px','left':relativeX+'px'})

var this_data;

var point_id=obj.point_id;
var count_occurrences=obj.count_occurrences;
// $("#mouseover_span").remove();
//  $.when(query_point(obj))
//   .then(function(data){
//     console.log('to function'+obj.count_occurrences)
//     this_data=data;

//     console.warn('inside title '+obj.count_occurrences)
//           content='<div class="hoverbox" style="z-index:10000"><div id="point_centroid" class="'+obj.point_id+'"/></br><b>'+obj.count_occurrences+'</b> occurrences</br>';    
//         // content+='<div id="show_genus_id"><b>'+data.count_genus+'</b> different Genus</div></br>';
              
//      content+='<div id="show_scientificname_id"><b>'+data.num_species+'</b> different Species</div></br>';
   
//       content+='</div>' 

    
//    //  $('#mouseover_span').attr('title', content);

    
//     //return show_tipsy (obj,this_data);
    
   
// //show_tipsy (data,obj.point_id,obj.count_occurrences)
//   })

//console.dir(this_data)

var content='<div class="hoverbox" style="z-index:10000"><div id="point_centroid" class="'+obj.point_id+'"/></br><b>'+obj.count_occurrences+'</b> occurrences</br><div id="more_info">Get more info</div>'; 

 $('circle.mouseover_circle').attr('title', content).show();




        }
      }

              })

   })








$('#datasets_table tr').find('td:gt(2)').popover(
        {
            trigger: 'click',
            delay: { show: 300, hide: 5800 },
            html: true,
            placement: 'bottom',
             container: 'body',
            title: function () 
            {


              return '<span id="dataset_id">Dataset information</span><i class="icon-remove" style="color:black;float:right;"></i>';
            },
            content: function ()
            { 

            var td_pos=this.cellIndex;
         $('.td_selected').removeClass('td_selected');

           //$(this).css({'cursor':'pointer','background':'#3e71f0'})

            
              var taxa_level=$('#datasets_table th').eq(td_pos).attr('class');

              $('.popover').not(this).hide()

               $(this).addClass('td_selected');


              var dataset_id=$(this).parent().attr('id').split('_')[1]

            return "<div id='plot_graphic' class='"+dataset_id+'_'+taxa_level+"'> Plot as graphic</div><div id='plot_list' class='"+dataset_id+'_'+taxa_level+"'> Plot as list</div><div id='my_data' style='overflow-y:auto;max-height:250px'></div>"
                  }
    }).bind('hover',function ()
  {
   //$(this).css({'cursor':'pointer','background':'#3e71f0'})
    $(this).addClass('td_hovered')  
  }).bind('mouseout',function ()
  {
  $(this).removeClass('td_hovered')
  })


$('#datasets_table .popover').live('click',function (event)
{
var $this=$(this) 

var $target=$(event.target)
var splitted_class=$target.attr('class').split('_')
console.info(splitted_class)
var dataset_id=splitted_class[0]
var taxa_level=splitted_class[1]

if ($(event.target).hasClass('icon-remove'))
{
//$(this).hide();
$('.td_selected').removeClass('td_selected');
}
else
{
if (event.target.id=='plot_graphic')  
{
var top=10;
 get_data (taxa_level,dataset_id,top,$this.find(".popover-content"),'graphic',datapublisher_id)  
}
else
{
  
get_data (taxa_level,dataset_id,top,$this.find(".popover-content"),'list',datapublisher_id)  
}
}

})

$('.hoverbox div, .hoverbox b ').live('hover',function (event)
 {
$(event.target).toggleClass('selected')
 })
 

 $('.hoverbox').live('click',function(event)
           {
          
          big_array=[];
           target=event.target     
 
           target_id=target.id;

           var my_id=$(this).find('#point_centroid').attr('class');          
        
           switch(target_id)
           {

           case 'more_info':
 


       jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_counts_point.php',
             data: {point_id:my_id,data_id:datapublisher_id,'data_type':'datapublisher'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {
 
            var content='<div id="show_genus_id">Nombre genres <b>'+data.num_genus+'</b>';
            console.info(content)
            $(target).html(content)               
              
                }
              })
    
           case 'show_genus_id': 
           
   
       $(event.target).toggleClass('selected')
      
            var content='';
             jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_taxonomic_arrays_final2.php',
             data: {point_id:my_id,taxa:'genus',datapublisher_id:datapublisher_id,'data_type':'datapublisher'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {
                    for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');

                        big_array.push(d)

                        }
                      window.to_plot='genus';
                      

                      orderby('names',big_array,to_plot) 
                      
                      

          }
            })  
           //console.warn('targeting genus'+$my_id);
          return false; 
          break;

            case 'show_phylum_id': 

           

        //   options={url: 'http://localhost:8887/test_maps/get_taxonomic_arrays.php',data: {id:my_id}}
            var content='';
             jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/get_taxonomic_arrays_final.php',
              data: {point_id:my_id,taxa:'phylum',data_id:datapublisher_id,'data_type':'datapublisher'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {
//  console.warn(data)
window.to_plot='phylum'
       for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');
                 
                        big_array.push(d)
                 
                        }
                 

                      orderby('names',big_array,to_plot) 
           

          }
            })
           //console.warn('targeting genus'+$my_id);
          return false; 
          break;
   case 'show_order_id': 

           

        //   options={url: 'http://localhost:8887/test_maps/get_taxonomic_arrays.php',data: {id:my_id}}
            var content='';
             jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/get_taxonomic_arrays_final.php',
              data: {point_id:my_id,taxa:'orderr',data_id:datapublisher_id,'data_type':'datapublisher'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {
        for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');

                        big_array.push(d)

                        }
                      window.to_plot='order';
                      orderby('names',big_array,to_plot) 

          }
            })
           //console.warn('targeting genus'+$my_id);
          return false; 
          break;
          case 'show_class_id': 
            var content='';
             jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/get_taxonomic_arrays_final.php',
              data: {point_id:my_id,taxa:'classs',data_id:datapublisher_id,'data_type':'datapublisher'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {

window.to_plot='classs'
             for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');

                        big_array.push(d)

                        }

                      orderby('names',big_array,to_plot) 
    
           

          }
            })
           //console.warn('targeting genus'+$my_id);
          return false; 
          break;
          
          case 'show_scientificname_id':
          

            var content='';
                        jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_taxonomic_arrays_final.php',
               data: {point_id:my_id,taxa:'scientificname',data_id:datapublisher_id,'data_type':'datapublisher'},
                        type: 'GET',
                        dataType: 'jsonp',
                        success: function(data)
                        {
            
                        for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');
                        big_array.push(d)
                        }
                      window.to_plot='scientificname';
                      orderby('names',big_array,to_plot) 

               
                      }
                        })
            
          break;
            
            
            
           default: //alert('nooops'); 
           break;
           }
//           $.get..

       
           })



$('#map').append("<div class='wax-tooltip' style='display:none;'><i class='icon-remove' style='color:#9C0890;float:right;'></i><div id='wax-tooltip_content'></div></div><div class='legend-tooltip'><i class='icon-remove' style='color:#9C0890;float:right;'></i><div class='legend-tooltip_content'></div></div>");

$('.legend-tooltip').hide()
$('.legend-tooltip .icon-remove').click(function ()
{
$('.legend-tooltip').hide()
})

      $('#orderby_counts').live('click',function()
          {
          orderby('counts',big_array,to_plot)
          })

          $('#orderby_names').live('click',function()
          {
          orderby('names',big_array,to_plot)
          })


}) 


</script>
<div class="container">
<div class="page-header well alert-info">
      <h1>${dataPublisher.name}</h1>
    </div> 
<div id='map_container' >

   <div class="navbar" >
     <div class="navbar-inner" style='height:40px;'>
       <div class="container">

        <div class="nav-collapse">
           <ul class="nav">  

           <li id='french_layers_manager'  class="dropdown">
                  <a data-toggle="dropdown" class="dropdown-toggle" style="padding-top: 0px;" href="#">French geo-layers<b class="caret" ></b></a>
            <ul id="fr_layers" class="dropdown-menu" style='width:auto;display:visible'>
               <li id="communes_france"><i class='icon-eye-open'></i><i class='icon-exchange'></i>Communes</li>
               <li id="wpda_france"><i class='icon-eye-open'></i><i class='icon-exchange'></i>Protected Areas</li>


            </ul>
            </li>

             <li id='international_layers_manager'  class="dropdown">
                  <a data-toggle="dropdown" class="dropdown-toggle" style="padding-top: 0px;" href="#">International geo-layers<b class="caret" ></b></a>
            <ul id="int_layers" class="dropdown-menu" style='width:auto;display:visible'>
               <li id="wpda_africa"><i class='icon-eye-open'></i><i class='icon-exchange'></i>African World Protected Area </li>               
            </ul>
            </li>
            <li id='stats_manager'  class="dropdown">
                  <a data-toggle="dropdown" class="dropdown-toggle" style="padding-top: 0px;" href="#">Statistics<b class="caret" ></b></a>
            <ul id="stats_layers" class="dropdown-menu" style='width:auto;display:visible'>
              <!-- <li id="stats_regions">Régions</li>-->
               <li id="stats_departements"><i class='icon-eye-open'></i><i class='icon-exchange'></i>Départements</li>
            </ul>
            </li>

            <li id='config_manager'  class="dropdown">
            <a data-toggle="dropdown" class="dropdown-toggle" style="padding-top: 0px;" href="#">Configuration options<b class="caret" ></b></a>
            <ul id="config_layers" class="dropdown-menu" style='width:auto;display:visible'>
               
               <li id='mousemove' class="red_tipsy">
             Show info on mouseover </li>
               <li id='mouseup'>Show info on mouseup  </li>
                   
            </ul>

            <li id='layers_manager'  class="dropdown">
            <a data-toggle="dropdown" class="dropdown-toggle" style="padding-top: 0px;" href="#">Layers manager<b class="caret" ></b></a>
             <ul class="dropdown-menu" style='width:auto;display:visible'>
             <li id='hide_points' class='red_tipsy hide_it'>Hide points layer</li>
             <li id='hide_points_search' class='red_tipsy hide_it'>Hide points search</li>
           </ul>
          
          
          
        </li>
        </li>

        </div>
        </div>
        </div>
        </div> 
 <div id="map" style='width:100%;height:500px;position:relative;border: 4px solid #d1003b;'></div>
    <div id='map_tooltip' style='display:none'></div> 
</div>
<div class="container-fluid">
     
  <div class="row-fluid">
    
 <div id='fullscreen'>Click here for fullscreen</div>

 <div id='no_fullscreen'>REmove fullscreen</div>

<!--    <div class="nav-collapse">
   <ul class="nav">
      <li class="dropdown"><a data-toggle="dropdown" class="dropdown-toggle" href="#">Show biodiversity by polygon<b class="caret"></b></a>
          <ul id='polygon_type' class="dropdown-menu">
            <li id='departements'><a  href="#">Departements</a></li>
            <li id='cantons'><a  href="#">Cantons</a></li>
            <li id='arrondissements'><a  href="#">Arrondissements</a></li>
            <li id='regions'><a  href="#">Regions</a></li>
          </ul>
      </li>
    </ul>

  
  
   </div> -->


 <!--    <ul style='list-style:none;margin:0 0 0 0'>
    <li id='occurrences'><a href="#">Check biodiversity map by occurrences</a></li>
  </ul> -->
<!--
    <div class="nav-collapse">
    <div class="nav">
      <li class="dropdown">
        <a data-toggle="dropdown" class="dropdown-toggle" href="#">Check 5 most abundant taxa statistics by<b class="caret"></b></a>
          <ul id='stats_type' class="dropdown-menu">
            <li id='kingdom'><a  href="#">kingdom</a></li>
             <li id='phylum'><a  href="#">phylum</a></li>
             <li id='family'><a  href="#">family</a></li>
             <li id='order'><a  href="#">order</a></li>
             <li id='class'><a  href="#">class</a></li>
             <li id='genus'><a  href="#">genus</a></li>
             <li id='scientificname'><a  href="#">scientificname</a></li>             
          </ul>  
      </li>
    </div>  
    </div>
  
    </ul> -->

  
 <!--    <div class="btn btn-small"></div>  -->
<!-- 
    <div class="page-header well alert-success">

    <h2>${dataPublisher.name}</h2>
      </div> -->
      <div class="btn-group">


      <table id='datapublisher_table' class="taxa_table table-condensed">
      <tbody>
        <tr>          
          <th>Occurrences géoréferencés</th>
          <th>Total occurrences</th>
           
          <th class='scientificName'>Èspeces</th>
          <th class='genus'>Genus</th>
          <th class='family'>Family</th>
          <th class='orderr'>Order</th>
          <th class='classs'>Class</th>
          <th class='phylum'>Phylum</th>
          <th class='kingdom'>Kingdom</th>  
        </tr>        
      </tbody>
    </table>
      </div>


      <h3>Datasets</h3>
      <div class="btn-group">
      <table id='datasets_table' class="taxa_table table-condensed">
      <tbody>
        <tr>
          <th>Dataset</th>
          <th>Occurrences géoréferencés</th>
          <th>Total occurrences</th>
           
          <th class='scientificName'>Èspeces</th>
          <th class='genus'>Genus</th>
          <th class='family'>Family</th>
          <th class='orderr'>Order</th>
          <th class='classs'>Class</th>
          <th class='phylum'>Phylum</th>
          <th class='kingdom'>Kingdom</th>   
        </tr>        
      </tbody>
    </table>
      </div>
    </div>

        <div id='data_list-dropdown-trigger' style='cursor:pointer;display:none;color:#2eb352;font-weight:bold;margin-top:10px' href="#" data-dropdown="#data_list-dropdown">Liste taxonomique</div> 
          <div id="data_list-dropdown" class="dropdown-menu has-tip has-scroll">

          </div>
     <div style='height:0px;' id='graphic'></div>
    <!-- <table class="table table-condensed table-striped">
      <tbody>
        <tr>
          <th>Description</th>
          <td>${dataPublisher.description}</td>
        </tr>
        <tr>  
          <th>Adresse</th>
          <td>${dataPublisher.address}</td>
        </tr>  
      </tbody>
    </table> -->
  </div>
  <div style='display:none' data-property="font-size" class="dial first">
    <ul><li data-value="1">1</li><li data-value="0.6">0.6</li><li data-value="0.2">0.2</li><li data-value="0">0</li></ul></div>
  </div>
</div>