#{extends 'main.html' /}
<script src="@{'/public/javascripts/highcharts.js'}"></script>
<script src="@{'/public/javascripts/exporting.js'}"></script>
<script src="@{'/public/javascripts/mapping/map_functions.js'}"></script>
<script src="@{'/public/javascripts/mapping/attach_events.js'}"></script>
#{set title:'Home' /}
<style type="text/css">


#more_info:hover
{
cursor:pointer;
color: #AF0734;
font-weight: bold;
}
[rel=popover][data-style=waypoints_popover] + .popover {
    width:190px;
    height:auto;
/*     background: blue;  */
}
/* not working */
[rel=popover][data-style=waypoints_popover] + > .popover-inner {
    width:190px; !important
    height:auto;
    background: red;
}

.dial {
  float:left;
  width:140px;
  margin-left:10px;
  position:relative;
  left:10%;
}

.dial.first {
  margin-left:0;
}

.dial h2 {
  font-weight:bold;
}

.dial ul {
  background:#fff;
  border:1px solid #bbb;
  padding:25px 0 114px 0;
  height:1px;
  overflow-y:scroll;
}

.dial ul:before {
  content://;
  border:10px solid #555;
  width:1px;
  height:1px;
  display:block;
  position:absolute;
  bottom:105px;
  left:0;
  z-index:3;
  border-top-color:transparent;
  border-right-color:transparent;
  border-bottom-color:transparent;
}

.dial li {
  height:20px;
  line-height:20px;
  padding:10px 10px 10px 20px;
  border-bottom:1px solid #ddd;
  font-size:20px;
}

.dial li:first-child {
  border-top:1px solid #ddd;
}

#fr_layers i:hover
{
  cursor:pointer;
  background-color:#839fd6 ;
  color: #FCF9F9;
  font-weight: bold;

}
.icon-eye-open, .icon-exchange
{color: #4725C4; padding-right: 10px; padding-top: 2px;}
.icon-eye-open
{
  float: left; 
}
.icon-eye-close
{float: left; color: #ba0d0d; padding-right: 10px; padding-top: 2px;}

.wax-tooltip {
  z-index:50;
  position:absolute;
  background:#1a1a1a;
  color:#fff;
  padding:7px;
 // left:1100px;
 right: 10px;
  top:30px;
  border:2px solid #5CACEE;
  border-radius:2px;
  max-width:300px;
  max-height: 400px;
  overflow: auto;
  opacity:1;
  font-type: Georgia;
  line-height: 1.3em;
  font-size: 1em;
//  width: auto;
  -webkit-transition:opacity .9s;
  -moz-transition:opacity .9s;
  box-shadow:0px 0px 10px #5CACEE;
  -moz-box-shadow:0px 0px 10px #5CACEE;
  -webkit-box-shadow:0px 0px 10px #5CACEE;
  }

.taxa_table td {
  padding: 8px;
  line-height: 14px;
  text-align: center;
  vertical-align: center;
  
}

.td_selected
{
cursor:pointer;
background:#f54f4f;
color:white;
font-weight: bold;
font-size: 18px;
}
.td_hovered
{
cursor:pointer;
background:#3e71f0;
color:white;
font-weight: bold;
font-size: 18px;
}


.selected
{
  color: #C60F0F;
  font-weight: bold;
}
       /* path  {
            
             stroke-width: 1px;
            stroke: #3b3535;
            shape-rendering: crispEdges;
        }*/

  #map_tooltip
  {
width:auto;position:relative;z-index:50;background:#DDDDDD; color:#6053;font-size: 1.1em;  
max-height:50px;
 -webkit-transition:opacity .5s;
  -moz-transition:opacity .5s;
  box-shadow:0px 0px 10px #5CACEE;
  -moz-box-shadow:0px 0px 10px #5CACEE;
  -webkit-box-shadow:0px 0px 10px #5CACEE; border:2px solid #5CACEE;
  border-radius:2px;

}
</style>
<!-- <script src="@{'/public/javascripts/jquery.xcolor.js'}"></script>    -->
<script type="text/javascript">
var data;
var datapublishers_json;

  var my_dataset_id=parseInt("${dataset.id}")
  var dataset_name="${dataset.title}";
  var datapublisher_id=get_datapub_id(my_dataset_id);
  var datapublisher_name="${dataset.dataPublisher.name}";

var colors=['blue','turquoise','darkcyan','blueviolet','cornflowerblue','lightseagreen','lime','orange','orangered','royalblue','greenyellow','gold',]
var ramp_colors=new Array();


var num_plotted_taxa=0;
for (i=0;i<colors.length-1;i++)
{

var c=d3.rgb(colors[i]);
colors[i]=new Array();
colors[i].push(c.brighter(1).toString()); // 
colors[i].push(c.darker(1).toString()); 
ramp_colors.push(colors[i])
}

function compareCount(a, b)
 {
 var my_a=parseInt(a[1]);
 var my_b=parseInt(b[1]);           
   if (my_a > my_b) return -1;
   if (my_a < my_b) return 1;
   return 0;
 }
 
 function compareName(a, b)
 {
    if (a[0] < b[0]) return -1;
   if (a[0] > b[0]) return 1;
   return 0;
 }
orderby= function(type,big_array,to_plot)
            {
var sorted_array=big_array.sort(compareCount);           
var content='';
   
 //           content+="<h3>"+to_plot+" abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
            switch (to_plot)
            {
            case 'genus': 
            var content="<h3>Genus abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
            break;
            
      case 'scientificname': 
      var content="<h3>Species abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break;       

          case 'family': 
      var content="<h3>Family abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break;    
             case 'classs': 
      var content="<h3>Class abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break; 
                case 'order': 
      var content="<h3>Order abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break;       
                   case 'order': 
      var content="<h3>Phylum abundance</h3><span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
      break;

            }
            if (type=='counts')
            {
         //   console.warn(to_plot)
            content+="<span style='color:#0CACF7' id='orderby_names'>Order by name</span></br>";
            console.dir(big_array)
            var sorted_array=big_array.sort(compareCount);            
            }
            if (type=='names')
            {

            content+="<span style='color:#0CACF7' id='orderby_counts'>Order by abundance</span></br>";
            var sorted_array=big_array.sort(compareName);                 
            }

      for (i=0;i<sorted_array.length;i++)
      {
//      $taxa_div=$('<div>'+sorted_array[i][0]+'</div>');
      content+='<span><div class="red_tipsy">'+sorted_array[i][0]+'</div> '+sorted_array[i][1]+'</span></br>';
        
      }
      content+="<span id='remove_pol' style='display:none;' class='yellow_tipsy'>Remove polygonal layer</span>";
//      console.info(content)
      $('#wax-tooltip_content').empty().append(content).show();
    
      if (!$('.wax-tooltip').is(':visible'))  $('.wax-tooltip').show()

        $('#wax-tooltip_content div').tipsy({ 
            container: $('#map'),
                              delayIn: 200, 
                              fade: true, 
                              gravity: 'e', 
                opacity:1,
                              offset: 15,
                              delayOut: 3000,
                              html: true, 
                              title: function(e,target) {                               
                                var this_taxa=$(this).html();   
                                        
    
           
                var text='<div id="explore_sp"><a this_taxa="'+this_taxa+'" deg="1" href="#" class="by_polygon">Visualize 1 degrees area</a><p>';
                text+='<a this_taxa="'+this_taxa+'" deg="0_5" href="#" class="by_polygon">Visualize 0.5 degree area</a><p>';
               
                                
                                
                                
                               // text+='<a this_taxa="'+this_taxa+'" href="#" class="heatmap">Visualize heatmap</a><br>
                               text+='<a this_taxa="'+this_taxa+'" href="#" class="canvas">Visualize individual occurrences</a>';
                              text+='</div>';
                                // text+='<p><a this_taxa="'+this_taxa+'" href="#" class="by_all">Get clusters for all collections</a>';
                             
                                return text;
                                
                              }
                            });
}
  
  
var new_colors=$.xcolor.analogous('#a5db97',30);
colors=new Array();
for (d in new_colors)
{
var this_color_obj=new_colors[d]
var this_color='rgb('+this_color_obj.r+','+this_color_obj.g+','+this_color_obj.b+')'
colors.push(this_color)
}

function render_highchart (render_to,this_array,title)
{
  chart = new Highcharts.Chart({
            chart: {
               backgroundColor: '#E1F5E8',
                renderTo: render_to,
                //'graph_freq_taxa',
               
                plotBorderWidth: null,
                plotShadow: false
               
            },
            colors:colors,
            title: {
                text: title
            },
            tooltip: {
              useHTML: true,

            formatter: function(){
                return '<span class="my_highcart_tooltip">'+this.point.name+' '+addSeparator(this.point.y)+' ('+this.point.percentage.toFixed(2)+'%)</span>';
            },
          //    pointFormat: '<b>{point.y}</b> ({point.percentage})%</b>',
              backgroundColor: 'rgba(20,19,19,1)',

              
              percentageDecimals: 1,
              style: {
                    
                    borderWidth: 2,
                    borderColor: '#AAA',
                    color:'white',
                    overflow:'auto',
                    width:'200px',
                    fontSize: '10pt',
                padding: 10,
                fontWeight: 'bold'
            }
            },
            plotOptions: {
                pie: {
                    //showInLegend:true,
                    allowPointSelect: true,
                    borderColor: '#DAE4E8',
                     borderWidth: 1,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,

                        style: {
                          
                          color:'black',
                          fontSize: '12px'
                        },
                        useHTML:true,
                        formatter: function () 
                        {
                          var label_type;
                          var this_name=this.point.name;
                          if (render_to=='graph_freq_taxa')                        
                        {
                           label_type='taxa_label';
                            if (this_name.length>20)
                          {
                            this_name=this_name.split(' ');
                            this_name=this_name[0]+' '+this_name[1]
                          }
                        }
                             if (render_to=='graph_freq_dataset')                        
                        {
                             label_type='datasets_label';
                        }
                          
                          

                    return '<div style="max-width:100px;height:auto;" class="'+label_type+'" id="'+this.point.config[2]+'"><b>'+this_name+'</b></div>';
                  //  return '<div id="'+this.point.config[2]+'"><b>'+this.point.name+'</b></div>'
                          // : '+this.y+' occurrences
                         } 
                     }
                    ,
                    // showInLegend: true
                }
            },
              legend: {
            align: 'right',
            verticalAlign: 'top',
            width:100,  
            x: -100,
            y: 100
          },
            series: [{
                type: 'pie',
                
                data: this_array,
                 events: {
                                  click: function(e) {
                                  //    alert ('A series was added');
                                  console.warn(e.point)
                                 console.info(e.point.config[0])
              
                                  }
                              }
            }]
        });

 function search_ecatID (this_taxa)
 {
        return function ()
  {
  
  $.getJSON('http://ecat-dev.gbif.org/ws/usage/?rkey=1&q='+this_taxa+'&searchType=canonical&callback=?',
       { format:'JSONP'},
       function(json, textStatus) 
    {
      var id=json.data[0].taxonID;
      console.warn(id)
      return id;
    });
  }
 }
 
 } 

jQuery(document).ready(function($) {

var num_plotted_taxa=0; 

simple_orderby= function(type,big_array,to_plot)
            {
var sorted_array=big_array.sort(compareCount);           
return sorted_array;
}

$('#extra_outils').hide()
var interaction;

$('#explore_sp a').live('click',function()
{

cluster_action=$(this).attr('class')
window.taxa=$(this).attr('this_taxa').toString();
if (cluster_action=='by_polygon')
{
window.pol_degree=$(this).attr('deg')
show_by_polygon2('dataset')
}

if (cluster_action=='canvas')
 {
jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_extents_canvas_final.php',
  data:  {'taxa':taxa,'type':to_plot,'data_type':'datapublisher','data_id':datapublisher_id},
 
 dataType: 'jsonp',
 success: function(data)
 {

$.each(map._layers, function(index, value)  
      {
      if (value.type=='canvas')
      {
map.removeLayer(value)
      }
      })


if (data.main_bbox[0].length= 0) 
  {
   alert('some error in bbox??')
   zoom=2;
    map.fitWorld()
  }
  else
  {
  if (typeof data.main_bbox[1]=='undefined') alert('We cannot get any geo-referenced record for this taxa')
    else
    {

       
        
     var max=data.max;
                     
    var up_right=data.main_bbox[1].split(',')
    var bottom_left=data.main_bbox[0].split(',')
    
 bounds = new L.LatLngBounds(
        new L.LatLng(bottom_left[1],bottom_left[0]),

        new L.LatLng(up_right[1],up_right[0]));

zoom=map.getBoundsZoom(bounds)

var message='<b>'+addSeparator(data.total)+'</b> occurrences of taxa <b>'+taxa+'</b> distributed in <b>'+addSeparator(data.num_clusters)+'</b> circles<br><b>Minimum</b> '+addSeparator(data.min)+'   <b>Maximum</b> '+addSeparator(data.max);

if ($('.notify').size()>0) $('.notify').remove()

$('#map_tooltip').before("<div class='notify'>"+message+"</div>").show()

map.fitBounds(bounds) 

var my_tile = new L.TileLayer.TileJSON({
        debug: false,
        opacity:0.7,
       
        // this value should be equal to 'radius' of your points        
        buffer: 5
    });
  my_tile.type='canvas';      
        

     my_tile.createUrl = function (bounds) {
 

   var bbox='BOX('+bounds[0]+'  '+bounds[1]+','+bounds[2]+' '+bounds[3]+')'
        var url = 'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/canvas_test_final.php?data_type=dataset&type='+to_plot+'&taxa='+taxa+'&zoom=5&data_id='+my_dataset_id+'&BBOX='+bbox;          
       return url
    };
    my_tile.styleFor = function (feature) {

  /*  var count_extent = d3.extent(features, function(d){return d.properties.count});
    var opacityScale = d3.scale.linear()
                     .domain([0, d3.max(features, function(d) { return d.properties.count; })])
                     .range([0.2, 1]);  
    */                 
                     
        var type = feature.geometry.type;
        var count=feature.properties.count
        
        
  if (map.getZoom()>=3)
   {
  var radius=(count*15)/max
   }
   else
   {
    var radius=(count*10)/max
   }
 
        switch (type) {
            case 'Point': return {
                    color: 'black',
                    radius: radius,
                    outline: {
                    color: 'red',
                    size: 3
                    }
                };

            default:
                return null;
        }
    };
       map.addLayer(my_tile);




      //  $menu_manager=$('#menu_manager')
       
      // $('#occ_manager').append("<div id='canvas_manager'><li><label id='canvas'><span style='width:50px;height:50px;color:black' >▉</span>  <b> "+taxa+'  </b><span action="remove_canvas">   Remove   </span></li></div>')

// $('#canvas').click(function()
// {

// $.each(map._layers, function(index, value)  
//       {
//       if (value.type=='canvas')
//       {
// map.removeLayer(value)
//       }
//       })
//       $('#canvas_manager').remove()
      
// })
   // if (!$menu_manager.is(':visible')) $menu_manager.show();
    
    }



  }


 }
})
}
})

var datapublishers_json = (function () {
    var json = null;
    $.ajax({
        'async': false,
        'global': false,
       // 'url': 'http://www.gbif.fr:8080/gbiffrance_portal_test/public/json/datapub_stats/taxa_graphic_simple/datapublisher_'+datapublisher_id+'_graphic.json',
         'url': '/public/json/datapub_stats/taxa_graphic_simple/datapublisher_'+datapublisher_id+'_graphic.json',
        'dataType': "json",
        'success': function (data) {
            json = data;
            
            for (dataset_id in data)
            {
              
              if (dataset_id==my_dataset_id)
              {

               var html='<tr id="dataset_'+dataset_id+'">';
                var dataset_info=data[dataset_id]['dataset_info'][0]

              $('#map_tooltip').html('<h2><b>'+addSeparator(dataset_info.dataset_geo_count)+'</b> occurrences géoreferencés').fadeIn('slow')
                  
                for (info in dataset_info)
                {

                html+='<td>'+dataset_info[info]+'</td>';
                }
                html+='</tr>';
                
                $('#datasets_table tr:first').after(html)
         
              }

              }
            

               
        }
    });
    return json;
})(); 
var taxa_array=null;
function get_data (taxa_level,dataset_id,top,to_plot,data_type,datapublisher_id)
{

$.ajax({
        url: 'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/parsing_json.php',
        data:{'taxa_level':taxa_level,'dataset':dataset_id,'datapublisher':datapublisher_id},
        dataType: 'jsonp',
        success: function (data) {
            taxa_array=data[taxa_level];
            var top_taxa=[];
            var top=10;
            
                   for (var i = 0; i < taxa_array.length; ++i)
          {    
      
      if (i<top)
      {
           
              top_taxa.push(taxa_array[i])
            }
          }
          

          var order_by_count=simple_orderby('count',taxa_array,'testing') 
          var html='<ul>'
          
          $(order_by_count).each(function(i,d)
          {           
          html+='<li>'+d[0]+'  '+addSeparator(d[1])+'</li>';
          })
          html+='</ul>';
          if (data_type=='graphic')
          {
          $('#graphic').animate({'height':350},500); 

         render_highchart('graphic',top_taxa,'test occurrences d\'un  total de 234')
           $('#data_list-dropdown').append(html)
          }
           else
           {
          //get_data (taxa_level,dataset_id,top,$this.find(".popover-content"),'list',datapublisher_id)  


          to_plot.find('#my_data').append(html)  
           }

          }

        })
return taxa_array;
}

var lat=48.856930;
var lng=2.341200;
var latlng=new L.LatLng(lat,lng);


 map = new L.Map('map',{ 'crs': L.CRS.EPSG900913});
map.addLayer(new L.Marker(latlng)); 

  map.scrollWheelZoom.disable();

var create_circles=function(data,options)
 {
 
maxValue=data.total;
cluster_degree=data.cluster_degree;
var zoom=options.zoom;

 min_range=7;
   max_range=20;

var rScale = d3.scale.linear()
                     .domain([0, d3.max(data.features, function(d) { return d.properties.count; })])
                     .range([min_range, max_range]);

var count_extent = d3.extent( data.features, function(d){return d.properties.count});



   var ramp =d3.scale.linear().domain(count_extent).range(ramp_colors[num_plotted_taxa]);
   //.interpolate(d3.cie.interpolateLch);

    /* Add a LatLng object to each item in the dataset */
  
    data.features.forEach(function(d) {

      d.LatLng = new L.LatLng(d.geometry.coordinates[1],d.geometry.coordinates[0])
    })



var circle = g.selectAll("circle").attr('taxa_gbif_id',function (d) {

  return d.properties.point_id;})
      .data(data.features,function (d){ 
        

d.total_occurrences=data.total;
d.number_clusters=data.num_clusters;

return d.properties.point_id});


      
      circle.enter().append("circle")//.attr('taxa_gbif_id',function (d) {d.properties.random_id})
circle.attr('taxa_gbif_id',function (d) {return d.properties.point_id;});

function first_update() 
    {
      console.warn('first update')
      circle.attr("cx",function(d) { return map.latLngToLayerPoint(d.LatLng).x})
      circle.attr("cy",function(d) { return map.latLngToLayerPoint(d.LatLng).y}).attr("stroke", "black")

      circle.on("mouseover", function(d) {})

      .on("mouseout", function(d) {
         var _this=d3.select(this)
     })
//attr('r',0).transition().duration(50).
      circle.attr("r", function(d) {
       // console.warn(rScale(d.properties.count))
        return rScale(d.properties.count);
      }).attr('fill',function (d){ 
 
  return ramp(d.properties.count)
        })
                        .attr('opacity',0.7)

          console.info(circle.attr('r'))
 
    }
first_update()
}  //end create_circles


var datapublisher_info=datapublishers_json.datapublisher_info[0];

var datapublisher_name=datapublishers_json.datapublisher_name;



if (datapublisher_name!=='undefined')
{

 var simple_datapublisher_url='http://www.gbif.fr/mbtiles/datasets/dataset_'+my_dataset_id+'/metadata.jsonp';

$('#map').append("<div id='mouseover_span' style='position:relative;cursor:pointer;width:20px;height:20px;opacity:0.001;'></div>")


        var url='http://a.tiles.mapbox.com/v2/pereion.map-fr0rgo1u.jsonp';
       // var url='http://a.tiles.mapbox.com/v3/examples.map-dev-fr.jsonp'
     wax.tilejson(url, function(tilejson) {
        console.warn('added basemap')
          basemap = new wax.leaf.connector(tilejson);
         map.addLayer(basemap,true);
         })



 // var simple_datapublisher_url='http://www.gbif.fr/mbtiles/dataset_1_2/metadata.jsonp';
    wax.tilejson(simple_datapublisher_url, function(tilejson) {
          this_datapublisher = new wax.leaf.connector(tilejson);
             this_datapublisher.bringToFront()

         map.addLayer(this_datapublisher,false);
 
         console.warn('added MY MAP')
         this_datapublisher.setOpacity(1)
  
        var center=tilejson.center.split(',')
         var lat=center[1];
        var lng=center[0];
        var zoom=center[2];
        var latlng=new L.LatLng(lat,lng);

                 map.setView(latlng, zoom);
 
 map._initPathRoot() 

 svg = d3.select("#map").select("svg")
 g = svg.append("g");

var latlng=new L.LatLng(0,0)
  
var mouseover_circle = g.selectAll("mouseover_circle").data(function ()
    {
       return [latlng];
    })


mouseover_circle.enter().append("circle").attr('class','mouseover_circle')
mouseover_circle.attr("cx",function(d) {  return map.latLngToLayerPoint(d).x})
mouseover_circle.attr("cy",function(d) { return map.latLngToLayerPoint(d).y}).attr("stroke", "black")

mouseover_circle.attr("r", 10).attr('fill','#BE3CDF').attr('opacity',0);

 $('circle.mouseover_circle').tipsy({ opacity:1,gravity: 'n',delayOut:25000, html: true, container: $('#map'),
 title: 'title'
                       
   });

 map.on("viewreset", function ()
  {
      reset();
 //dirty workaround to keep points in front
this_datapublisher.bringToFront();
    $(".tipsy").hide()
  })

map.on('viewreset dragend zoomend',function(e)
{

 if(parseInt($("circle.mouseover_circle").attr('opacity'))!==0)
 {
  var request_x=map.latLngToLayerPoint(requested_latlng).x;
  
  var request_y=map.latLngToLayerPoint(requested_latlng).y;


  mouseover_circle.transition()
  .attr("cx",request_x).attr("cy",request_y).duration(10).attr('opacity',1); 
}
  //dirty workaround to keep points in front
  this_datapublisher.bringToFront();
  // console.warn(map.getZoom()>parseInt(tilejson.maxzoom))
  // console.warn(map.getZoom()+">"+parseInt(tilejson.maxzoom))
  // console.warn('attaching events on viewreset zoom '+map.getZoom())

   $("circle.mouseover_circle").attr('original-title','');

  if (map.getZoom()>parseInt(tilejson.maxzoom))
  {
     //g.selectAll("circle").remove()
var ne=e.target.getBounds()._northEast;
var sw=e.target.getBounds()._southWest;
ne_bounds=ne.lng+' '+ne.lat;
sw_bounds=sw.lng+' '+sw.lat;

var bbox='BOX('+sw_bounds+','+ne_bounds+')'

var url = 'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_d3.php?dataset_id='+my_dataset_id+'&datapublisher_id='+datapublisher_id+'&BBOX='+bbox;

   jQuery.ajax({
    type: "GET",
    url: url,
    dataType: "jsonp",
    timeout:5000,

    success: function(data){
     var ajax_params={zoom:map.getZoom()}
   //  create_circles.call(this,data,ajax_params);

    }

  })
  }
  else
  {
    console.warn('remove circles if present map.getZoom()>='+tilejson.maxzoom)
    
  var circles=g.selectAll("circle").filter(function() {
  return d3.select(this).attr('class') !== 'mouseover_circle';
});
    circles.remove();

   //if (g.selectAll("circle").remove()
  }

})



var content;
    this_datapublisher.interaction= wax.leaf.interaction(this_datapublisher)
    this_datapublisher.interaction.map(map)
    .tilejson(tilejson)     
    .on({
      on: function(o) {
  
          
         if (o.e.type !== 'mousemove') 
        {
    var $map=$('#map').get(0)
       var relativeX = o.e.pageX - $map.offsetLeft-10; 
var relativeY = o.e.pageY - $map.offsetTop-10;
var obj=o.data;



var latlng=map.mouseEventToLatLng(o.e)
requested_latlng=map.mouseEventToLatLng(o.e);


 var this_y=map.latLngToLayerPoint(latlng).y
var this_x=map.latLngToLayerPoint(latlng).x



mouseover_circle.transition()
  .attr("cx",this_x).attr("cy",this_y).duration(150).attr('opacity',1)   

      if (typeof obj.point_id!=='undefined') point_id=obj.point_id
        else point_id=obj.oid
//<div id="tooltip_datapublisher_id" class="'+datapublisher_id+'" > Datapublisher <b>'+datapublisher_name+'</b></div>
     var content='<div class="hoverbox" style="z-index:10000"><div id="point_centroid" class="'+obj.point_id+'"/></br><b>'+obj.count_occurrences+'</b> occurrences</br><div id="more_info">Get more info</div>'; 

 $('circle.mouseover_circle').attr('title', content);
      
     
 
  $('circle.mouseover_circle').attr('title', content);

// $('#mouseover_span').css({'top':relativeY+'px','left':relativeX+'px'})

//  $('#mouseover_span').tipsy({fade: false, delayOut:2000,gravity: 'e', html: true, 
// title: function () 
//  {
//   console.warn(content)
//  return content;//content
// }
                       
//   });


        }
      }

              })

   })


$('.hoverbox').live('click',function(event)
           {
          
          big_array=[];
           target=event.target     
 
           target_id=target.id;
           var my_id=$(this).find('#point_centroid').attr('class');          
        
           switch(target_id)
           {

           case 'more_info':
 


       jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_counts_point.php',
             data: {point_id:my_id,data_id:datapublisher_id,data_type:'dataset',dataset_id:my_dataset_id},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {
 
            var content='<div id="show_genus_id">Nombre Genus <b>'+data.num_genus+'</b>';
            $(target).html(content)                             
              
                }
              });
       return false;
       break;
    
           case 'show_genus_id': 
           
   
       $(event.target).toggleClass('selected')
      
            var content='';
             jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_taxonomic_arrays_final2.php',
             data: {point_id:my_id,taxa:'genus',data_id:datapublisher_id,'data_type':'dataset'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {
                    for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');

                        big_array.push(d)

                        }

                      window.to_plot='genus';
                      

                      orderby('names',big_array,to_plot) 
                      
                      

          }
            })  
           //console.warn('targeting genus'+$my_id);
          return false; 
          break;

            case 'show_phylum_id': 

           

        //   options={url: 'http://localhost:8887/test_maps/get_taxonomic_arrays.php',data: {id:my_id}}
            var content='';
             jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/get_taxonomic_arrays_final.php',
              data: {point_id:my_id,taxa:'phylum',data_id:datapublisher_id,'data_type':'datapublisher'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {
//  console.warn(data)
window.to_plot='phylum'
       for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');
                 
                        big_array.push(d)
                 
                        }
                 

                      orderby('names',big_array,to_plot) 
           

          }
            })
           //console.warn('targeting genus'+$my_id);
          return false; 
          break;
   case 'show_order_id': 

           

        //   options={url: 'http://localhost:8887/test_maps/get_taxonomic_arrays.php',data: {id:my_id}}
            var content='';
             jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/get_taxonomic_arrays_final.php',
              data: {point_id:my_id,taxa:'orderr',data_id:datapublisher_id,'data_type':'datapublisher'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {
        for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');

                        big_array.push(d)

                        }
                      window.to_plot='order';
                      orderby('names',big_array,to_plot) 

          }
            })
           //console.warn('targeting genus'+$my_id);
          return false; 
          break;
          case 'show_class_id': 
            var content='';
             jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/get_taxonomic_arrays_final.php',
              data: {point_id:my_id,taxa:'classs',data_id:datapublisher_id,'data_type':'datapublisher'},
             type: 'GET',
            dataType: 'jsonp',
            success: function(data)
            {

window.to_plot='classs'
             for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');

                        big_array.push(d)

                        }

                      orderby('names',big_array,to_plot) 
    
           

          }
            })
           //console.warn('targeting genus'+$my_id);
          return false; 
          break;
          
          case 'show_scientificname_id':
          

            var content='';
                        jQuery.ajax({url:'http://lully.snv.jussieu.fr/gbif/mapping/php/dataportal/get_taxonomic_arrays_final.php',
               data: {point_id:my_id,taxa:'scientificname',data_id:datapublisher_id,'data_type':'datapublisher'},
                        type: 'GET',
                        dataType: 'jsonp',
                        success: function(data)
                        {
            
                        for (i=0;i<data['data'].length;i++)
                        {
                        var d=data['data'][i].split('+');
                        big_array.push(d)
                        }
                      window.to_plot='scientificname';
                      orderby('names',big_array,to_plot) 

               
                      }
                        })
            
          break;
            
            
            
           default: //alert('nooops'); 
           break;
           }
//           $.get..

       
           })

$('#map').append("<div class='wax-tooltip' style='display:none;'><i class=icon-remove'></i><div id='wax-tooltip_content'></div></div>")

      $('#orderby_counts').live('click',function()
          {
          orderby('counts',big_array,to_plot)
          })

          $('#orderby_names').live('click',function()
          {
          orderby('names',big_array,to_plot)
          })

 $('#occurrences a').click(function(event)
{

 this_datapublisher.setOpacity(1)
  $('#map').animate({'height':'500px'})
  
 // map.invalidateSize()
  event.preventDefault()
}) 
}


$('#datasets_table tr').find('td:gt(2)').popover(
        {
            trigger: 'click',
            delay: { show: 300, hide: 5800 },
            html: true,
            placement: 'bottom',
             container: 'body',
            title: function () 
            {


              return '<span id="dataset_id">Dataset information</span><i class="icon-remove" style="color:black;float:right;"></i>';
            },
            content: function ()
            { 

            var td_pos=this.cellIndex;
         $('.td_selected').removeClass('td_selected');

           //$(this).css({'cursor':'pointer','background':'#3e71f0'})

            
              var taxa_level=$('#datasets_table th').eq(td_pos).attr('class');

              $('.popover').not(this).hide()

               $(this).addClass('td_selected');


              var dataset_id=$(this).parent().attr('id').split('_')[1]

            return "<div id='plot_graphic' class='"+dataset_id+'_'+taxa_level+"'> Plot as graphic</div><div id='plot_list' class='"+dataset_id+'_'+taxa_level+"'> Plot as list</div><div id='my_data' style='overflow-y:auto;max-height:250px'></div>"
                  }
    }).bind('hover',function ()
  {
   //$(this).css({'cursor':'pointer','background':'#3e71f0'})
    $(this).addClass('td_hovered')  
  }).bind('mouseout',function ()
  {
  $(this).removeClass('td_hovered')
  })



$('.popover').live('click',function (event)
{
var $this=$(this) 

var $target=$(event.target)
var splitted_class=$target.attr('class').split('_')
console.info(splitted_class)
var dataset_id=splitted_class[0]
var taxa_level=splitted_class[1]

if ($(event.target).hasClass('icon-remove'))
{
$(this).hide();
$('.td_selected').removeClass('td_selected');
}
else
{
if (event.target.id=='plot_graphic')  
{
var top=10;
 get_data (taxa_level,dataset_id,top,$this.find(".popover-content"),'graphic',datapublisher_id)  
}
else
{
  
get_data (taxa_level,dataset_id,top,$this.find(".popover-content"),'list',datapublisher_id)  
}
}

})





}) 


</script>
<div class="container">
  <div class="well">
    <h1>${dataset.title}</h1>
    <h3>${dataset.dataPublisher.name}</h3>    
  </div>

     <div id="map_container">

       <div class="navbar" >
     <div class="navbar-inner" style='height:40px;'>
       <div class="container">

        <div class="nav-collapse">
           <ul class="nav">  

           <li id='french_layers_manager'  class="dropdown">
                  <a data-toggle="dropdown" class="dropdown-toggle" style="padding-top: 0px;" href="#">French geo-layers<b class="caret" ></b></a>
            <ul id="fr_layers" class="dropdown-menu" style='width:auto;display:visible'>
               <li id="communes_france"><i class='icon-eye-open'></i><i class='icon-exchange'></i>Communes</li>
               <li id="wpda_france"><i class='icon-eye-open'></i><i class='icon-exchange'></i>Protected Areas</li>


            </ul>
            </li>

             <li id='international_layers_manager'  class="dropdown">
                  <a data-toggle="dropdown" class="dropdown-toggle" style="padding-top: 0px;" href="#">International geo-layers<b class="caret" ></b></a>
            <ul id="int_layers" class="dropdown-menu" style='width:auto;display:visible'>
               <li id="wpda_africa"><i class='icon-eye-open'></i><i class='icon-exchange'></i>World Protected Area France</li>               
            </ul>
            </li>



            <li id='stats_manager'  class="dropdown">
                  <a data-toggle="dropdown" class="dropdown-toggle" style="padding-top: 0px;" href="#">Statistics<b class="caret" ></b></a>
            <ul id="stats_layers" class="dropdown-menu" style='width:auto;display:visible'>
               <li id="regions">Régions</li>
               <li id="departements"><i class='icon-eye-open'></i><i class='icon-exchange'></i>Départements</li>
            </ul>
            </li>


        </div>
        </div>
        </div>
        </div>    


    <div id="map" style='width:100%;height:500px;position:relative'></div>
   <div id='map_tooltip' style='display:none'></div>
   </div>

      <h3>Dataset statistics</h3>
      <div class="btn-group">
      <table id='datasets_table' class="taxa_table table-condensed">
      <tbody>
        <tr>
         <th>Dataset</th>
         <th>Total occurrences</th>
           <th>Occurrences géoréferencés</th>
          <th class='scientificName'>Èspeces</th>
          <th class='genus'>Genus</th>
          <th class='family'>Family</th>
          <th class='orderr'>Order</th>
          <th class='classs'>Class</th>
          <th class='phylum'>Phylum</th>
          <th class='kingdom'>Kingdom</th>    
        </tr>        
      </tbody>
    </table>
      </div>


      <div id='data_list-dropdown-trigger' style='cursor:pointer' href="#" data-dropdown="#data_list-dropdown">List</div> 
          <div id="data_list-dropdown" class="dropdown-menu has-tip has-scroll">

          </div>
     <div style='height:0px;background-color:#E1F5E8;' id='graphic'></div>

  <div id="dataset-basic-info" class="row">
    <div id="dataset-basic-info-description" class="span6">
      <h3>Description</h3><hr>
      #{if !dataset.description}
        <i>Information non fournie.</i>
      #{/if}
      #{else}
        ${dataset.description}
      #{/else}
    </div>
    <div class="span6">
    <div id="dataset-basic-info-others">
      <table class="table table-condensed">
        <tr>
          <th>Resource Language</th>
          <td>${dataset.resourceLanguage}</td>
        </tr>          
        <tr>
          <th>Basis of Record</th>
          <td>${dataset.basisOfRecord}</td>
        </tr>
      </table>  
    </div>
    <div id="dataset-external-links" class="">
      <table class="table table-condensed">
        <tr>
          <th>Home Page</th>
          <td>${dataset.homePageLink}</td>
        </tr>          
        <tr>
          <th>Dwc-A Link</th>
          <td>${dataset.dwcArchiveLink}</td>
        </tr>
      </table>  
    </div>
    <div id="dataset-geographic-info">
    <table class="table table-condensed">
      <tr>
        <th>Geographic Coverage</th>
        <td>${dataset.geographicCoverageDescription}</td>
      </tr>          
      <tr>
        <th>Bounding box</th>
        <td>${dataset.geographicCoverageBoundingCoordinates}</td>
      </tr>
    </table>  
  </div>
  <div id="dataset-taxonomic-info">
    <table class="table table-condensed">
      <tr>
        <th>Taxonomic Coverage</th>
        <td>${dataset.taxonomicCoverageDescription}</td>
      </tr>          
      <tr>
        <th>Taxon List</th>
        <td>${taxonomicCoverageTaxonList}</td>
      </tr>
    </table>  
  </div>
  <div id="dataset-temporal-info">
    <table class="table table-condensed">
      <tr>
        <th>Temporal Coverage</th>
        <td>${dataset.temporalCoverageDate}</td>
      </tr>           
    </table>  
  </div>
  <div id="dataset-sampling-info">
    <table class="table table-condensed">
      <tr>
        <th>Sampling Description</th>
        <td>${dataset.samplingDescription}</td>
      </tr>           
    </table>  
  </div>
  </div>
  </div>
  <div id="dataset-contact-info" class="">
    <table class="table table-striped table-condensed">
      <h3>Contacts</h3>
      <tr>
        <th/>
        <th>Name</th>
        <th>Role</th>
        <th>Address</th>
        <th>Email</th>
        <th>Telephone</th>
      </tr>
      <tr>
        <td>Resource Contact</td>  
        <td>${dataset.resourceContactName}</td>
        <td>${dataset.resourceContactRole}</td>
        <td>${dataset.resourceContactAddress}</td>
        <td>${dataset.resourceContactEmail}</td>
        <td>${dataset.resourceContactTelephone}</td>
      </tr>
      <tr>
        <td>Resource Creator</td>  
        <td>${dataset.resourceCreatorName}</td>
        <td>${dataset.resourceCreatorRole}</td>
        <td>${dataset.resourceCreatorAddress}</td>
        <td>${dataset.resourceCreatorEmail}</td>
        <td>${dataset.resourceCreatorTelephone}</td>
      </tr>
      <tr>
        <td>Metadata Provider</td>  
        <td>${dataset.metadataProviderName}</td>
        <td>${dataset.metadataProviderRole}</td>
        <td>${dataset.metadataProviderAddress}</td>
        <td>${dataset.metadataProviderEmail}</td>
        <td>${dataset.metadataProviderTelephone}</td>
      </tr>
    </table>
  </div>
  
  <div style='display:none' data-property="font-size" class="dial first">
    <ul><li data-value="0">0</li><li data-value="0.3">0.3</li><li data-value="0.6">0.6</li><li data-value="1">1</li></ul></div>
  
</div>